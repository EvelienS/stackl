version: '3'
networks:
  default:
    external:
      name: stackl
  stackl_bridge:
    external:
      name: stackl_bridge
services:
  stackl-rest:
    restart: always
    image: {{stackl_image_url_app}}:{{full_version}}
    container_name: stackl_app  #this is ignored in swarm mode
    deploy:
      placement:
        constraints:
          - node.labels.purpose_api == true
    networks:
     - default
     - stackl_bridge
    volumes:
      - /lfs_test_store/:/lfs_test_store/
    ports:
      - 8080:80
      - 8888:8888
    environment:
      - STACKL_STORE=LFS
      - STACKL_TASK_BROKER=Custom
      - STACKL_AGENT_BROKER=Custom
      - STACKL_MESSAGE_CHANNEL=RedisSingle
      - STACKL_LOGPATH=/var/log/stackl.log
      - STACKL_STACKLRESTHOST=stackl-rest
      - STACKL_STACKLRESTPORT=80
      - STACKL_REDIS_HOST=stackl-redis
      - STACKL_REDIS=stackl-redis
      - STACKL_REDISSENTINELHOST=stackl-redis
      - TCP_PORTS=80
      - SERVICE_PORTS=80
      - STACKL_CACERT=/certs/ca.crt
      - STACKL_PKIHOST=stackl.stackl.io
      - STACKL_PKIPORT=8443
      - STACKL_PKICA=intermCA

  stackl-worker:
    restart: always
    image: {{stackl_image_url_worker}}:{{ full_version }}
    networks:
     - default
     - stackl_bridge
    deploy:
      placement:
        constraints:
          - node.labels.purpose_api == true
    stdin_open: true
    tty: true
    volumes:
      - /stackl-efs/stackl-crl:/crl/
      - /stackl-efs/stackl-certs:/certs/
      - /lfs_test_store/:/lfs_test_store/
    depends_on:
      - stackl-rest
      - stackl-redis
    ports:
      - 9999:9999
    environment:
      - STACKL_STORE=LFS
      - STACKL_TASK_BROKER=Custom
      - STACKL_MESSAGE_CHANNEL=RedisSingle
      - STACKL_AGENT_BROKER=Custom
      - STACKL_LOGPATH=/var/log/stackl.log
      - STACKL_STACKLRESTHOST=stackl-rest
      - STACKL_STACKLRESTPORT=80
      - STACKL_REDIS_HOST=stackl-redis
      - STACKL_REDIS=stackl-redis
      - STACKL_REDISSENTINELHOST=stackl-redis
      - STACKL_ROLE=worker
      - STACKL_CACERT=/certs/ca.crt
      - STACKL_SERVERCERT=/certs/server.crt
      - STACKL_SERVERKEY=/certs/server.key
{% if stackl_use_crl == true %}
      - STACKL_CRL=/crl/crl.pem
{% endif %}
      - TCP_PORTS=8888

  stackl-redis:
    restart: always
    image: redis:5.0.5
    deploy:
      placement:
        constraints:
          - node.labels.redis == master
          - node.labels.purpose_api == true
    networks:
     - default
     - stackl_bridge

  {# stackl-agent:
    restart: always
{% if agent_broker_type == 'Custom' %}
    image: stackl_agent
{% else %}
    image: grpc_agent
{% endif %}
    ports:
      - 8889:8889
      - 50051:50051
    environment:
      - STACKL_LOGPATH=/var/log/stackl.log
      - STACKL_STACKLRESTHOST=stackl-rest
      - STACKL_STACKLRESTPORT=80
      - TAGS=['common'] #}